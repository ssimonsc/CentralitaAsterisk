[general]

[default]

[phones]

;SERVIZO DE CHAMADAS
exten => _1XX,1,Answer(1000) 													;Collemos a chamada entrante

same => n,Set(UsuarioAoQueChamamos=${EXTEN}) 									;Gardamos o numero ao que chamamos
same => n,Set(NosoUsuario=${CALLERID(num)}) 			   					 	;Gardamos o noso usuario

same => n,GotoIf($[${DB(${UsuarioAoQueChamamos}/${NosoUsuario})}=1]?ListaNegra) ;Comprobamos se estamos na lista negra do numero ao que chamamos

same => n,GotoIf($[${DB(${UsuarioAoQueChamamos}/DND)}=1]?nondisponhibel)		;Comprobamos se ten o servizo Non molesar activado

same => n,Dial(SIP/${EXTEN},15,m) 												;Establecemos a chamada, cun tempo maximo para que o usuario responda de 15 segundos con musica en espera
same => n,GotoIf($[${DIALSTATUS}=NOANSWER]?find)								;Se o usuario non respondeu pasados 15 segundos pasamos ao servizo findme
same => n,GotoIf($[${DIALSTATUS}=BUSY]?busy)									;Se o usuario rexeito a chamada salatamos ao buzon de voz coa mensaxe de ocupado

same => n(find),GotoIf($[${DB_EXISTS(${UsuarioAoQueChamamos}/numero1)}]?:preg2)				;Comprobamos se ten un outra extension ao que poder chamar
same => n,PlayBack(call&first&extension)													
same => n,Dial(SIP/${DB(${UsuarioAoQueChamamos}/numero1)},15,m)								;Chamamos ao segundo numero
same => n,GotoIf($[${DIALSTATUS}=NOANSWER]?preg2)											;Se non reponde tras 15 segundos comprobamos coa segunda extension
same => n,GotoIf($[${DIALSTATUS}=BUSY]?busy) 	
same => n(preg2),GotoIf($[${DB_EXISTS(${UsuarioAoQueChamamos}/numero2)}]?:(nondisponhibel))	;Se non ten segunda extension finalizamos, se a ten chamamos a esta
same => n,PlayBack(call&second&extension)
same => n,Dial(SIP/${DB(${UsuarioAoQueChamamos}/numero2)},15,m)								;Chamamos á segunda extension
same => n,GotoIf($[${DIALSTATUS}=NOANSWER]?nondisponhibel)									;Se non responde saltamos ao buzon de voz de non disponhibel
same => n,GotoIf($[${DIALSTATUS}=BUSY]?busy) 	

same => n(nondisponhibel),VoiceMail(${UsuarioAoQueChamamos}@vmphones,u)						;Buzon de voz con mensaxe de non dispoñibel
same => n,Hangup 																			;colgamos

same => n(busy),VoiceMail(${UsuarioAoQueChamamos}@vmphones,b)                               ;Buzon de voz coa mensaxe de ocupado
same => n,Hangup

same => n(ListaNegra),PlayBack(privacy-you-are-blacklisted)                     			;Vostede esta na lista negra
smae => n,Hangup

;*******************************************************************************************************************************************

;CHAMADA AO USUARIO SERGIO
exten => sergio,1,Answer(1000)
same => n,Set(caller2=${EXTEN})
same => n,GotoIf($[${DB(${caller2}/DND)}=1]?colgar)
same => n,Dial(SIP/${EXTEN},15,m)
same => n(colgar),Hangup

;********************************************************************************************************************************************

;SERVIZO CONTAR
exten => 500,1,Set(NosoUsuario=${CALLERID(num)})
exten => 500,n,GotoIf($[${DB(${NosoUsuario}/DND)}=1]?colgar2)
exten => 500,n,Answer(1000)
exten => 500,n,Set(COUNT=1)
exten => 500,n,While($[${COUNT}<=5])
exten => 500,n,SayNumber(${COUNT})
exten => 500,n,Verbose(${INC(COUNT)})
exten => 500,n,EndWhile
exten => 500,n,Set(COUNT=$[${COUNT}-1])
exten => 500,n,While($[${COUNT}>1])
exten => 500,n,Set(COUNT=$[${COUNT}-1])
exten => 500,n,SayNumber(${COUNT})
exten => 500,n,EndWhile
exten => 500,n(colgar2),Hangup


;********************************************************************************************************************************************

;SERVIZO ECHO
exten => 600,1,Answer
same => n,MusicOnHold()o 9665
same => n,ECHO
same => n,Playback(demo-echodone)
same => n,Hangup

;*******************************************************************************************************************************************

;SERVIZO MENU
exten => 700,1,Goto(menu,s,1) 													;Saltamos ao contexto menu

;********************************************************************************************************************************************

;SERVIZO NON MOLESTAR
exten => 800,1,Answer															
same => n,Set(NosoUsuario=${CALLERID(num)})										;Gardamos o noso usuario
same => n,GotoIf($[${DB(${NosoUsuario}/DND)}=1]?deshab)							;Comprobamos se ten o servizo non-molestar activado
same => n,Set(DB(${NosoUsuario}/DND)=1)											;Se o ten desactivado o activamos e finalizamos
same => n,PlayBack(do-not-disturb&enabled)	
same => n,Goto(fin)
same => n(deshab),Set(DB(${NosoUsuario}/DND)=0)									;Se o ten activado o desactivamos e finalizamos
same => n,PlayBack(do-not-disturb&disabled) 
same => n(fin)Hangup

;******************************************************************************************************************************************

;SERVIZO BUZON DE VOZ
exten => 900,1,Answer(1000)
same => n,VoiceMailMain(${CALLERID(num)}@vmphones,u)
same => n,Hangup

;********************************************************************************************************************************************

;CHAMADA A UNHA EXTENSION QUE NON EXISTE
exten => _X.,1,Answer(1000)
same => n,Playback(pbx-invalid)
same => n,Hangup

;********************************************************************************************************************************************
;********************************************************************************************************************************************
;********************************************************************************************************************************************


[menu]
exten => s,1,Answer(1000)
same => n(loop),Background(press-1&service&voice-mail-system&or&press-2&service&do-not-disturb&or&press-3&service&privacy-blacklisted&press-4&service&extensions)
same => n,WaitExten(10)

;XESTION DO MEU VOICEMAIL(1)
exten => 1,1,Answer(1000)
same => n,VoiceMailMain(${CALLERID(num)}@vmphones,u)
same => n,Hangup
same => n,Goto(s,loop)

;SERVIZO NON MOLESTAR(2)
exten => 2,1,Answer
same => n,Set(caller=${CALLERID(num)})
same => n,GotoIf($[${DB(${caller}/DND)}=1]?deshab)
same => n,Set(DB(${caller}/DND)=1)
same => n,PlayBack(do-not-disturb&enabled)
same => n,Goto(fin)
same => n(deshab),Set(DB(${caller}/DND)=0)
same => n,PlayBack(do-not-disturb&disabled) 
same => n(fin)Hangup
same => n,Goto(s,loop)

;SERVIZO LISTA NEGRA(3)
;Non olvidemos comprobar que o usuario non introduzca varias veces a mesma extension a bloquear
;Meter mensaxes de non podes incluir na lista negra e de numero incluido

exten => 3,1,Answer(1000)
same => n,Set(minhaBlackList=${CALLERID(num)})													;Gardamos o noso usuario
same => n,GotoIf($[${DB_EXISTS(${minhaBlackList}/contador)}]?existe)
same => n,Set(DB(${minhaBlackList}/contador)=0)
same => n(existe),Goto(ListaNegra,s,1) 															;Saltamos ao contexto ListaNegra

;SERVIZO FINDEME
exten => 4,1,Answer(1000)
same => n,Set(caller=${CALLERID(num)})															;Gardamos o noso usuario
same => n,Goto(FindMe,s,1) 																		;Saltamos ao contexto FindeMe

;exten => 4,1,Answer(1000)
;same => n,Set(minhaBlackList=${CALLERID(num)})	
;same => n,Set(DB(${minhaBlackList}/contador)=0)
;same => n(non),Hangup

exten => i,1,Playback(pm-invalid-option)
same => n,Goto(s,loop)

exten => t,1,Playback(vm-goodbye)
same => n,Hangup

;***************************************************************************************************************************************************************************
[ListaNegra]
exten => s,1,Answer(1000)
same => n(loop),Background(press-1&or&press-2)
same => n,WaitExten(10)

exten => 1,1,GotoIf($[${DB(${minhaBlackList}/contador)}=3]?non)
same => n,Read(usuarioBL,enter-num-blacklist)													;Gardamos en usuarioBL a extension que introduzcamos polo DTMF
same => n,GotoIf($[${DB_EXISTS(${minhaBlackList}/usuarioBL)}]?(non))							;Comprobamos que ese usuario non estea introducido xa na lista negra
same => n,Set(DB(${minhaBlackList}/${usuarioBL})=1)												;Gardamos o usuario introducido na nosa lista negra
same => n,Set(DB(${minhaBlackList}/contador)=$[${DB(${minhaBlackList}/contador)}+1])
same => n(non),Hangup
same => n,Goto(s,loop)

exten => 2,1,Read(usuarioBL,enter-num-blacklist)	
same => n,GotoIf($[${DB_EXISTS(${minhaBlackList}/${usuarioBL})}]?existe2)						;Gardamos en usuarioBL a extension que introduzcamos polo DTMF
;Mensaxe non existe
same => n,Hangup
same => n(existe2),verbose(${DB_DELETE(${minhaBlackList}/${usuarioBL})})						;Gardamos o usuario introducido na nosa lista negra
same => n,Set(DB(${minhaBlackList}/contador)=$[${DB(${minhaBlackList}/contador)}-1])
same => n(non),Hangup
same => n,Goto(s,loop)


;*******************************************************************************************************************************************************************************
[FindMe]

exten => s,1,Answer(1000)
same => n(loop),Background(press-1&added&extension&or&press-2&removed&extension)
same => n,WaitExten(10)

exten => 1,1,GotoIf($[${DB_EXISTS(${caller}/numero1)}]?preg2)
same => n,Read(numero1,please-enter-the&your&first&extension,3)
same =>	n,GotoIf($[${caller}=${numero1}]?invalido)
same => n,GotoIf($[${DB_EXISTS(${caller}/numero2)}]?:engadir1)
same =>	n,GotoIf($[${DB(${caller}/numero2)}=${numero1}]?:engadir1)
same => n,PlayBack(extension&repeater)
same => n,HangUp
same => n(engadir1),Set(DB(${caller}/numero1)=${numero1})
same => n,PlayBack(added&your&first&extension)
same => n,HangUp

same => n(preg2),GotoIf($[${DB_EXISTS(${caller}/numero2)}]?fin)
same => n,Read(numero2,please-enter-the&your&second&extension,3)
same =>	n,GotoIf($[${caller}=${numero2}]?invalido)
same =>	n,GotoIf($[${DB(${caller}/numero2)}=${numero2}]?:engadir2)
same => n(invalido),PlayBack(extension&repeater)
same => n,HangUp
same => n(engadir2),Set(DB(${caller}/numero2)=${numero2})
same => n,PlayBack(added&your&second&extension)
same => n(fin),HangUp

exten => 2,1, Read(numero,please-enter-the&your&extension,3)

same => n, GotoIf($[${DB(${caller}/numero1)}=${numero}]?borrar1)
same => n, GotoIf($[${DB(${caller}/numero2)}=${numero}]?borrar2)
same => n,HangUp

same => n(borrar1),NoOp(${DB_DELETE(${caller}/numero1)})
same => n,PlayBack(removed&your&extension)
same => n,HangUp
same => n(borrar2),NoOp(${DB_DELETE(${caller}/numero2)})
same => n,PlayBack(removed&your&extension)
same => n,HangUp

